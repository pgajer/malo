#!/usr/bin/env sh
# Fail fast
set -eu

PROFILE="${MALO_BUILD_PROFILE:-cran-safe}"

case "$PROFILE" in
  dev|cran-safe)
    ;;
  *)
    echo "configure: unsupported MALO_BUILD_PROFILE='$PROFILE' (use 'dev' or 'cran-safe')" 1>&2
    exit 1
    ;;
esac

echo "configure: selected build profile: $PROFILE" 1>&2
echo "configure: probing for sanitizer flags" 1>&2

ALLFLAGS="${CFLAGS:-} ${CPPFLAGS:-} ${CXXFLAGS:-} ${CXX11FLAGS:-} ${CXX14FLAGS:-} ${CXX17FLAGS:-} ${CXX20FLAGS:-} ${LDFLAGS:-}"
SAN_LINE=""
OMP_CXX_LINE=""
OMP_LIBS_LINE=""

case "$ALLFLAGS" in
  *-fsanitize=address*|*-fsanitize=undefined*|*-fsanitize=leak*)
    echo "configure: sanitizer detected -> using RcppParallel TinyThread backend" 1>&2
    SAN_LINE="export RCPP_PARALLEL_BACKEND=tinythread"
    ;;
  *)
    echo "configure: no sanitizer flags found (keeping default RcppParallel backend)" 1>&2
    ;;
esac

if [ "$PROFILE" = "dev" ]; then
  echo "configure: probing OpenMP flags for C++17 (dev profile)" 1>&2

  CXX17=`"${R_HOME}/bin/R" CMD config CXX17 2>/dev/null || true`
  CXX17FLAGS=`"${R_HOME}/bin/R" CMD config CXX17FLAGS 2>/dev/null || true`

  cat > conftest_omp.cpp <<'EOF'
#include <omp.h>
int main(void) { return omp_get_max_threads(); }
EOF

  if [ -n "$CXX17" ]; then
    if ${CXX17} ${CXX17FLAGS} -fopenmp conftest_omp.cpp -o conftest_omp >/dev/null 2>&1; then
      OMP_CXX_LINE="MALO_OPENMP_CXXFLAGS := -fopenmp"
      OMP_LIBS_LINE="MALO_OPENMP_LIBS := -fopenmp"
      echo "configure: OpenMP detected with '-fopenmp'" 1>&2
    elif [ "`uname -s`" = "Darwin" ]; then
      if [ "`uname -m`" = "arm64" ]; then
        HOMEBREW_PREFIX=/opt/homebrew
      else
        HOMEBREW_PREFIX=/usr/local
      fi
      LIBOMP_INCLUDE="-I${HOMEBREW_PREFIX}/opt/libomp/include -Xpreprocessor -fopenmp"
      LIBOMP_LINK="-L${HOMEBREW_PREFIX}/opt/libomp/lib -lomp"
      if [ -d "${HOMEBREW_PREFIX}/opt/libomp/include" ]; then
        if [ -d "${HOMEBREW_PREFIX}/opt/libomp/lib" ]; then
          if ${CXX17} ${CXX17FLAGS} ${LIBOMP_INCLUDE} conftest_omp.cpp ${LIBOMP_LINK} -o conftest_omp >/dev/null 2>&1; then
            OMP_CXX_LINE="MALO_OPENMP_CXXFLAGS := ${LIBOMP_INCLUDE}"
            OMP_LIBS_LINE="MALO_OPENMP_LIBS := ${LIBOMP_LINK}"
            echo "configure: OpenMP detected with Homebrew libomp (${HOMEBREW_PREFIX})" 1>&2
          else
            echo "configure: OpenMP not detected for C++17; dev profile will fail fast at compile time." 1>&2
          fi
        else
          echo "configure: OpenMP not detected for C++17; dev profile will fail fast at compile time." 1>&2
        fi
      else
        echo "configure: OpenMP not detected for C++17; dev profile will fail fast at compile time." 1>&2
      fi
    else
      echo "configure: OpenMP not detected for C++17; dev profile will fail fast at compile time." 1>&2
    fi
  else
    echo "configure: OpenMP not detected for C++17; dev profile will fail fast at compile time." 1>&2
  fi

  rm -f conftest_omp.cpp conftest_omp conftest_omp.o conftest_omp.exe
  rm -rf conftest_omp.dSYM
fi

mkdir -p src
{
  echo "# Auto-generated by configure. Do not edit by hand."
  echo "MALO_BUILD_PROFILE := $PROFILE"
  if [ -n "$OMP_CXX_LINE" ]; then
    echo "$OMP_CXX_LINE"
  fi
  if [ -n "$OMP_LIBS_LINE" ]; then
    echo "$OMP_LIBS_LINE"
  fi
  if [ -n "$SAN_LINE" ]; then
    echo "$SAN_LINE"
  fi
} > src/Makevars.local

echo "configure: wrote src/Makevars.local" 1>&2

exit 0
